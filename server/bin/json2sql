#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
  json2sql
  --------
  Consume JSON event stream into MySQL

  usage: json2sql [-h] [--sid SID] input db

  positional arguments:
    input       URI of JSON event stream to consume
    db          URI of DB to write to

  optional arguments:
    -h, --help  show this help message and exit
    --sid SID   set input socket identity
    --debug     output all generated SQL to stderr

  :copyright: (c) 2012 by Ori Livneh <ori@wikimedia.org>
  :license: GNU General Public Licence 2.0 or later

"""
from __future__ import division

import argparse
import logging
import sys

import eventlogging
import sqlalchemy


parser = argparse.ArgumentParser(description='JSON event stream -> MySQL')
parser.add_argument('input', help='URI of JSON event stream to consume')
parser.add_argument('db', help='URI of DB to write to')
parser.add_argument('--sid', help='set input socket identity')
parser.add_argument('--debug', action='store_const', dest='loglevel',
                    const=logging.INFO, default=logging.WARNING,
                    help='output all generated SQL to stderr')
args = parser.parse_args()

logging.basicConfig(stream=sys.stderr, level=args.loglevel)
logging.getLogger('sqlalchemy.engine').setLevel(args.loglevel)

# XXX(ori, 28-Apr-2013): this coerces 'utf8' client encoding to 'utf8mb4';
# required only until change XXX is merged.
if db.endswith('utf8'):
    db = db + 'mb4'
meta = sqlalchemy.MetaData(args.db)

sub = eventlogging.zmq_subscribe(args.input, sid=args.sid, json=True)

while 1:
    # Optimization: keep ``try/except`` block outside the inner loop.
    try:
        for ev in sub:
            logging.info(ev)
            eventlogging.store_event(meta, ev)
    except Exception:
        logging.exception('Unable to insert event: %s', ev)
